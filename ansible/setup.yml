---
- hosts: webserver
  become: yes
  vars:
    db_name: "{{ lookup('env', 'DB_NAME') }}"
    db_user: "{{ lookup('env', 'DB_USER') }}"
    db_password: "{{ lookup('env', 'DB_PASSWORD') }}"
    ec2_instance_ip: "{{ lookup('env', 'EC2_INSTANCE_IP') }}"
    rds_endpoint: "{{ lookup('env', 'RDS_ENDPOINT') }}"
    efs_id: "{{ lookup('env', 'EFS_ID') }}"
    aws_region: "{{ lookup('env', 'AWS_REGION') }}"
  tasks:
    - name: Install necessary packages
      yum:
        name:
          - httpd
          - php
          - php-mysqlnd
          - mysql
        state: present

    - name: Download WordPress
      get_url:
        url: https://wordpress.org/latest.tar.gz
        dest: /tmp/wordpress.tar.gz

    - name: Extract WordPress
      unarchive:
        src: /tmp/wordpress.tar.gz
        dest: /var/www/html/
        remote_src: yes

    - name: Configure WordPress
      template:
        src: templates/wp-config.php.j2
        dest: /var/www/html/wordpress/wp-config.php
      become: yes

    - name: Ensure Apache is running and enabled
      service:
        name: httpd
        state: started
        enabled: yes

    - name: Mount EFS
      mount:
        path: "/var/www/html/wordpress/wp-content"
        src: "{{ efs_id }}.efs.{{ aws_region }}.amazonaws.com:/"
        opts: "nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2"
        fstype: "nfs"
        state: mounted
