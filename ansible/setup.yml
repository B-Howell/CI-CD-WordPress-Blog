---
- hosts: webserver
  become: yes
  vars:
    db_name: "{{ lookup('env', 'DB_NAME') }}"
    db_user: "{{ lookup('env', 'DB_USER') }}"
    db_password: "{{ lookup('env', 'DB_PASSWORD') }}"
    ec2_instance_ip: "{{ lookup('env', 'EC2_INSTANCE_IP') }}"
    rds_endpoint: "{{ lookup('env', 'RDS_ENDPOINT') }}"
    efs_id: "{{ lookup('env', 'EFS_ID') }}"
    aws_region: "{{ lookup('env', 'AWS_REGION') }}"
  tasks:
    - name: Install necessary packages
      yum:
        name:
          - httpd
          - php
          - php-mysqlnd
          - mysql
          - amazon-efs-utils  # Adding the Amazon EFS utilities installation here
        state: present

    - name: Install Botocore
      pip:
        name: botocore
        state: present

    - name: Create a directory for mounting EFS
      file:
        path: /var/www/html/wordpress/wp-content  # Adjust this if you decide to mount directly to /mnt/efs as in your script
        state: directory
        mode: '0755'

    - name: Download WordPress
      get_url:
        url: https://wordpress.org/latest.tar.gz
        dest: /tmp/wordpress.tar.gz

    - name: Extract WordPress
      unarchive:
        src: /tmp/wordpress.tar.gz
        dest: /var/www/html/
        remote_src: yes

    - name: Configure WordPress
      template:
        src: templates/wp-config.php.j2
        dest: /var/www/html/wordpress/wp-config.php

    - name: Ensure Apache is running and enabled
      service:
        name: httpd
        state: started
        enabled: yes

    - name: Debug EFS ID
      debug:
        msg: "Mounting EFS with ID {{ efs_id }}"

    - name: Mount the EFS file system
      become: yes
      shell: |
        sudo mount -t efs -o tls {{ efs_id }} /var/www/html/wordpress/wp-content
      args:
        executable: /bin/bash


